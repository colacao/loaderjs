/*from tccdn minify at 2015-12-31 0:15:56,file：/touch/weixin/train/js/public/city/0.0.2/city.js*/
!function(){function a(a){return $.extend(this,{name:"city",hasSearch:!0,placeholder:"中文/拼音/首字母",hasLocation:1,nameAttr:"name",pyAttr:"fullPy",dataAttrMap:{id:"id",name:"name"},matchAttrs:["name","fullPy","shortPy"],historyCityName:"historyCities",cityFilter:function(){return!0},hotCityFilter:function(a,b){return a===b[this.nameAttr]},historyCityNumber:5},a),e.call(this),"asRequired"===this.mode?void($.isArray(this.hotCities)?f.call(this):b.call(this,f)):($.isArray(this.hotCities)?this.hotCitiesReady=!0:b.call(this,g),void($.isArray(this.cities)?(this.citiesReady=!0,g.call(this)):c.call(this,g)))}function b(a){var b=this,c=$.extend({},b.hotCities);c.success=function(c){b.hotCities.success&&(c=b.hotCities.success(c)),b.hotCities=c,b.hotCitiesReady=!0,a.call(b)},$.ajax(c)}function c(a,b){var c=this,d=$.extend({},c.cities);b&&(d.url=d.url.replace("{cityKey}",b.attr("data-city-key"))),d.success=function(d){c.cities.success&&(d=c.cities.success(d)),b?a.call(c,d,b):(c.cities=d,c.citiesReady=!0,a.call(c))},$.ajax(d)}function d(a,b){for(var c="",d=0,e=a.length;e>d;d++)c+=this.buildCityItem(a[d],"li");b.next().html(c)}function e(){this.elem?this.elem=$(this.elem):(this.elem=$('<div id="cityPage" class="page"></div>'),this.elem.appendTo($("body")));var a="";this.hasSearch&&(a+='<div class="search search-reset"><input placeholder="'+this.placeholder+'" /><span class="search-icon"></span><span class="clear"><i>×</i></span><span class="cancel">取消</span></div><div class="search-complete"></div>'),a+='<div class="city-wrapper"></div>',this.elem.append(a)}function f(){if(this.hotCitiesReady){var a="";this.hasLocation&&(a+='<h3 class="city-key-dw">定位</h3><ul class="dw-city">'+(1===this.hasLocation?'<li class="disabled">正在获取位置信息':'<li class="disabled get-location">点击获取当前位置')+"</li></ul>");for(var b=this.hotCities,e=[],f=0,g=b.length;g>f;f++)e.push(this.buildCityItem(b[f],"li"));a+='<h3 class="city-key-rm">热门</h3><ul>'+e.join("")+"</ul>",this.letters||(this.letters=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"]);var h,k=this.letters;for(f=0,g=k.length;g>f;f++)h=k[f],a+='<h3 class="city-key" data-city-key="'+h+'">'+h+"</h3><ul></ul>";$(".city-wrapper",this.elem).html(a),1===this.hasLocation&&i.call(this);var l=this;$(".city-wrapper",this.elem).delegate(".city-key","click",function(){var a=$(this);if(a.hasClass("open"))return void a.removeClass("open").next().addClass("closed");$(".open",a.liveFired).removeClass("open").next().addClass("closed"),a.addClass("open");var b=a.next();return b.hasClass("closed")?void b.removeClass("closed"):void c.call(l,d,a)}),j.call(this)}}function g(){if(this.hotCitiesReady&&this.citiesReady){var a,b,c,d=this.cities,e=[];this.completeData=[];for(var f=0,g=d.length;g>f;f++)a=d[f],this.cityFilter(a)&&(this.completeData.push(h.call(this,a)),b=a[this.pyAttr].toUpperCase().charCodeAt(0)-65,c=e[b],void 0===c&&(c=e[b]=[]),c.push(this.buildCityItem(a,"li")),this.getHotCity(a));c="";var k=[];this.hasLocation&&(c+='<h3 class="city-key-dw">定位</h3><ul class="dw-city">'+(1===this.hasLocation?'<li class="disabled">正在获取位置信息':'<li class="disabled get-location">点击获取当前位置')+"</li></ul>",k.push('<li data-key="dw">定位</li>'));var l=[];for(d=this.hotCities,f=0,g=d.length;g>f;f++)a=d[f],l.push(this.buildCityItem(a,"li"));c+='<h3 class="city-key-rm">热门</h3><ul>'+l.join("")+"</ul>",k.push('<li data-key="rm">热门</li>');var m;for(f=65;91>f;f++)e[f-65]&&(m=String.fromCharCode(f),k.push('<li data-key="'+m+'">'+m+"</li>"),c+='<h3 class="city-key-'+m+'">'+m+"</h3><ul>"+e[f-65].join("")+"</ul>");$(".city-wrapper",this.elem).html(c),$(this.elem).append('<ul class="city-nav">'+k.join("")+"</ul>"),1===this.hasLocation&&i.call(this),j.call(this)}}function h(a){for(var b=$.extend({match:[]},a),c=0,d=this.matchAttrs.length;d>c;c++)b.match.push(a[this.matchAttrs[c]]);return b}function i(){function a(a){if(a.tips)b.html('<li class="disabled'+(a.reject?"":" retry")+'">'+a.tips+(a.reject?"":"(点击重试)")+"</li>");else{var d=a.city.replace("市","");if("[object Object]"===Object.prototype.toString.call(c.cities)&&c.loc)ajaxObj=$.extend({},c.loc),ajaxObj.url=ajaxObj.url.replace("{cityName}",d),ajaxObj.url=ajaxObj.url.replace("{latitude}",a.latitude),ajaxObj.url=ajaxObj.url.replace("{longitude}",a.longitude),ajaxObj.success=function(a){c.loc.success&&(a=c.loc.success(a)),b.html("");for(var d in a)b.append(c.buildCityItem(a[d],"li"))},$.ajax(ajaxObj);else{for(var e=0,f=c.cities.length;f>e;e++)if(c.cities[e][c.nameAttr]===d){b.html(c.buildCityItem(c.cities[e],"li"));break}e===c.cities.length&&(b=$(".dw-city",this.elem).html('<li class="disabled">定位到的城市('+d+")不符合要求</li>"))}}}var b=$(".dw-city",this.elem).html('<li class="disabled">正在获取位置信息</li>'),c=this;$.location.gpsInfo?a($.location.gpsInfo):$.location(a)}function j(){var a=this,b=$(".search input",this.elem);$(".city-nav",a.elem).delegate("li","click",function(){window.scrollTo(0,$(".city-key-"+this.getAttribute("data-key"),a.elem).offset().top)}),$(".city-wrapper",this.elem).delegate("li","click ",function(){var b=$(this);b.hasClass("disabled")?(b.hasClass("get-location")||b.hasClass("retry"))&&i.call(a):l.call(a,this)}),this.hasSearch&&($(".search-complete",this.elem).on("click",function(){""===b[0].value&&setTimeout(function(){p.call(a)},300)}),b.on("focus",function(){a.autoComplete&&""===this.value&&(a.autoComplete.resetDefaultData(m.call(a)),a.autoComplete.show()),$(".search",this.elem).removeClass("search-reset"),$(".city-wrapper, .city-nav",this.elem).css({display:"none"}),$(".search-complete",this.elem).css({display:"block"})}).val("").trigger("keyup"),$(".clear",a.elem).on("click",function(){""!==b.val()&&(b.val(""),a.autoComplete.show())}),$(".cancel",a.elem).on("click",function(){b.val(""),p.call(a)}),o.call(this))}function k(a){var b="number"==typeof this.nameAttr?[]:{};for(var c in this.dataAttrMap)b[this.dataAttrMap[c]]=a.getAttribute("data-"+c);return b[this.nameAttr]||(b[this.nameAttr]=a.innerHTML),b}function l(a){var b=this,c=k.call(this,a);n.call(this,c),setTimeout(function(){p.call(b)},300),this.fn&&this.fn(c)}function m(){var a=localStorage.getItem(this.historyCityName);return a=a?JSON.parse(a):[]}function n(a){var b="";try{b=localStorage.getItem(this.historyCityName)}catch(c){}b=b?JSON.parse(b):[];for(var d=0,e=b.length;e>d;d++)if(b[d][this.nameAttr]===a[this.nameAttr]){b.splice(d,1);break}b.unshift(a),b.length>this.historyCityNumber&&b.splice(this.historyCityNumber,b.length-this.historyCityNumber);try{localStorage.setItem(this.historyCityName,JSON.stringify(b))}catch(c){}}function o(){var a=this,b={name:"value",type:"GET",url:"",dataType:"json",processFn:function(a){return a}};a.searchObj&&$.extend(b,a.searchObj),a.autoComplete=$(".search input",a.elem).autoComplete({content:$(".search-complete",a.elem),localData:a.completeData,defaultData:m.call(a),max:10,title:!1,needClose:!1,requestUrl:b.url,dataType:b.dataType,type:b.type,requestValName:b.name,processAjaxDataFn:b.processFn,itemValueFn:function(){return""},itemPrintFn:function(b){return a.buildCityItem(b,"div")},keepListOnNoResult:!1,showClosebtn:!1,selectItemFn:function(b,c){l.call(a,$("div",c)[0])},chooseClass:""})}function p(){$(".search-complete .autofill-wrap",this.elem).css({display:"none"}),$(".search",this.elem).addClass("search-reset"),$(".city-wrapper, .city-nav",this.elem).css({display:"block"}),$(".search-complete",this.elem).css({display:"none"})}$.city=function(b){if(b.elem){if($(".city-wrapper",b.elem).length)return}else if($("#"+(b.id||"city")+"Page .city-wrapper").length)return;new a(b)},a.prototype.buildCityItem=function(a,b){var c="<"+b;for(var d in this.dataAttrMap)c+=" data-"+d+'="'+a[this.dataAttrMap[d]]+'"';return c+=">"+a[this.nameAttr]+"</"+b+">"},a.prototype.getHotCity=function(a){if(this.hotCityFilter)for(var b=this.hotCities,c=0,d=b.length;d>c;c++)if(this.hotCityFilter(b[c],a)){b[c]=a;break}}}();
