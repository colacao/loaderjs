define("city",function (require, exports, module) {
!function(){function q(b){return $.extend(this,{name:"city",hasSearch:!0,placeholder:"中文/拼音/首字母",hasLocation:1,nameAttr:"name",pyAttr:"fullPy",dataAttrMap:{id:"id",name:"name"},matchAttrs:["name","fullPy","shortPy"],historyCityName:"historyCities",cityFilter:function(){return !0},hotCityFilter:function(c,d){return c===d[this.nameAttr]},historyCityNumber:5},b),u.call(this),"asRequired"===this.mode?void ($.isArray(this.hotCities)?v.call(this):r.call(this,v)):($.isArray(this.hotCities)?this.hotCitiesReady=!0:r.call(this,w),void ($.isArray(this.cities)?(this.citiesReady=!0,w.call(this)):s.call(this,w)))}function r(d){var e=this,f=$.extend({},e.hotCities);f.success=function(a){e.hotCities.success&&(a=e.hotCities.success(a)),e.hotCities=a,e.hotCitiesReady=!0,d.call(e)},$.ajax(f)}function s(e,f){var g=this,h=$.extend({},g.cities);f&&(h.url=h.url.replace("{cityKey}",f.attr("data-city-key"))),h.success=function(a){g.cities.success&&(a=g.cities.success(a)),f?e.call(g,a,f):(g.cities=a,g.citiesReady=!0,e.call(g))},$.ajax(h)}function t(f,g){for(var h="",i=0,j=f.length;j>i;i++){h+=this.buildCityItem(f[i],"li")}g.next().html(h)}function u(){this.elem?this.elem=$(this.elem):(this.elem=$('<div id="cityPage" class="page"></div>'),this.elem.appendTo($("body")));var b="";this.hasSearch&&(b+='<div class="search search-reset"><input placeholder="'+this.placeholder+'" /><span class="search-icon"></span><span class="clear"><i>×</i></span><span class="cancel">取消</span></div><div class="search-complete"></div>'),b+='<div class="city-wrapper"></div>',this.elem.append(b)}function v(){if(this.hotCitiesReady){var c="";this.hasLocation&&(c+='<h3 class="city-key-dw">定位</h3><ul class="dw-city">'+(1===this.hasLocation?'<li class="disabled">正在获取位置信息':'<li class="disabled get-location">点击获取当前位置')+"</li></ul>");for(var d=this.hotCities,i=[],j=0,m=d.length;m>j;j++){i.push(this.buildCityItem(d[j],"li"))}c+='<h3 class="city-key-rm">热门</h3><ul>'+i.join("")+"</ul>",this.letters||(this.letters=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"]);var n,o=this.letters;for(j=0,m=o.length;m>j;j++){n=o[j],c+='<h3 class="city-key" data-city-key="'+n+'">'+n+"</h3><ul></ul>"}$(".city-wrapper",this.elem).html(c),1===this.hasLocation&&y.call(this);var p=this;$(".city-wrapper",this.elem).delegate(".city-key","click",function(){var e=$(this);if(e.hasClass("open")){return void e.removeClass("open").next().addClass("closed")}$(".open",e.liveFired).removeClass("open").next().addClass("closed"),e.addClass("open");var f=e.next();return f.hasClass("closed")?void f.removeClass("closed"):void s.call(p,t,e)}),z.call(this)}}function w(){if(this.hotCitiesReady&&this.citiesReady){var h,i,j,n=this.cities,o=[];this.completeData=[];for(var p=0,G=n.length;G>p;p++){h=n[p],this.cityFilter(h)&&(this.completeData.push(x.call(this,h)),i=h[this.pyAttr].toUpperCase().charCodeAt(0)-65,j=o[i],void 0===j&&(j=o[i]=[]),j.push(this.buildCityItem(h,"li")),this.getHotCity(h))}j="";var H=[];this.hasLocation&&(j+='<h3 class="city-key-dw">定位</h3><ul class="dw-city">'+(1===this.hasLocation?'<li class="disabled">正在获取位置信息':'<li class="disabled get-location">点击获取当前位置')+"</li></ul>",H.push('<li data-key="dw">定位</li>'));var I=[];for(n=this.hotCities,p=0,G=n.length;G>p;p++){h=n[p],I.push(this.buildCityItem(h,"li"))}j+='<h3 class="city-key-rm">热门</h3><ul>'+I.join("")+"</ul>",H.push('<li data-key="rm">热门</li>');var J;for(p=65;91>p;p++){o[p-65]&&(J=String.fromCharCode(p),H.push('<li data-key="'+J+'">'+J+"</li>"),j+='<h3 class="city-key-'+J+'">'+J+"</h3><ul>"+o[p-65].join("")+"</ul>")}$(".city-wrapper",this.elem).html(j),$(this.elem).append('<ul class="city-nav">'+H.join("")+"</ul>"),1===this.hasLocation&&y.call(this),z.call(this)}}function x(e){for(var f=$.extend({match:[]},e),g=0,h=this.matchAttrs.length;h>g;g++){f.match.push(e[this.matchAttrs[g]])}return f}function y(){function d(b){if(b.tips){e.html('<li class="disabled'+(b.reject?"":" retry")+'">'+b.tips+(b.reject?"":"(点击重试)")+"</li>")}else{var c=b.city.replace("市","");if("[object Object]"===Object.prototype.toString.call(f.cities)&&f.loc){ajaxObj=$.extend({},f.loc),ajaxObj.url=ajaxObj.url.replace("{cityName}",c),ajaxObj.url=ajaxObj.url.replace("{latitude}",b.latitude),ajaxObj.url=ajaxObj.url.replace("{longitude}",b.longitude),ajaxObj.success=function(i){f.loc.success&&(i=f.loc.success(i)),e.html("");for(var j in i){e.append(f.buildCityItem(i[j],"li"))}},$.ajax(ajaxObj)}else{for(var g=0,h=f.cities.length;h>g;g++){if(f.cities[g][f.nameAttr]===c){e.html(f.buildCityItem(f.cities[g],"li"));break}}g===f.cities.length&&(e=$(".dw-city",this.elem).html('<li class="disabled">定位到的城市('+c+")不符合要求</li>"))}}}var e=$(".dw-city",this.elem).html('<li class="disabled">正在获取位置信息</li>'),f=this;$.location.gpsInfo?d($.location.gpsInfo):$.location(d)}function z(){var c=this,d=$(".search input",this.elem);$(".city-nav",c.elem).delegate("li","click",function(){window.scrollTo(0,$(".city-key-"+this.getAttribute("data-key"),c.elem).offset().top)}),$(".city-wrapper",this.elem).delegate("li","click ",function(){var a=$(this);a.hasClass("disabled")?(a.hasClass("get-location")||a.hasClass("retry"))&&y.call(c):B.call(c,this)}),this.hasSearch&&($(".search-complete",this.elem).on("click",function(){""===d[0].value&&setTimeout(function(){F.call(c)},300)}),d.on("focus",function(){c.autoComplete&&""===this.value&&(c.autoComplete.resetDefaultData(C.call(c)),c.autoComplete.show()),$(".search",this.elem).removeClass("search-reset"),$(".city-wrapper, .city-nav",this.elem).css({display:"none"}),$(".search-complete",this.elem).css({display:"block"})}).val("").trigger("keyup"),$(".clear",c.elem).on("click",function(){""!==d.val()&&(d.val(""),c.autoComplete.show())}),$(".cancel",c.elem).on("click",function(){d.val(""),F.call(c)}),E.call(this))}function A(d){var e="number"==typeof this.nameAttr?[]:{};for(var f in this.dataAttrMap){e[this.dataAttrMap[f]]=d.getAttribute("data-"+f)}return e[this.nameAttr]||(e[this.nameAttr]=d.innerHTML),e}function B(d){var e=this,f=A.call(this,d);D.call(this,f),setTimeout(function(){F.call(e)},300),this.fn&&this.fn(f)}function C(){var b=localStorage.getItem(this.historyCityName);return b=b?JSON.parse(b):[]}function D(f){var g="";try{g=localStorage.getItem(this.historyCityName)}catch(h){}g=g?JSON.parse(g):[];for(var i=0,j=g.length;j>i;i++){if(g[i][this.nameAttr]===f[this.nameAttr]){g.splice(i,1);break}}g.unshift(f),g.length>this.historyCityNumber&&g.splice(this.historyCityNumber,g.length-this.historyCityNumber);try{localStorage.setItem(this.historyCityName,JSON.stringify(g))}catch(h){}}function E(){var c=this,d={name:"value",type:"GET",url:"",dataType:"json",processFn:function(b){return b}};c.searchObj&&$.extend(d,c.searchObj),c.autoComplete=$(".search input",c.elem).autoComplete({content:$(".search-complete",c.elem),localData:c.completeData,defaultData:C.call(c),max:10,title:!1,needClose:!1,requestUrl:d.url,dataType:d.dataType,type:d.type,requestValName:d.name,processAjaxDataFn:d.processFn,itemValueFn:function(){return""},itemPrintFn:function(a){return c.buildCityItem(a,"div")},keepListOnNoResult:!1,showClosebtn:!1,selectItemFn:function(a,e){B.call(c,$("div",e)[0])},chooseClass:""})}function F(){$(".search-complete .autofill-wrap",this.elem).css({display:"none"}),$(".search",this.elem).addClass("search-reset"),$(".city-wrapper, .city-nav",this.elem).css({display:"block"}),$(".search-complete",this.elem).css({display:"none"})}$.city=function(a){if(a.elem){if($(".city-wrapper",a.elem).length){return}}else{if($("#"+(a.id||"city")+"Page .city-wrapper").length){return}}new q(a)},q.prototype.buildCityItem=function(e,f){var g="<"+f;for(var h in this.dataAttrMap){g+=" data-"+h+'="'+e[this.dataAttrMap[h]]+'"'}return g+=">"+e[this.nameAttr]+"</"+f+">"},q.prototype.getHotCity=function(e){if(this.hotCityFilter){for(var f=this.hotCities,g=0,h=f.length;h>g;g++){if(this.hotCityFilter(f[g],e)){f[g]=e;break}}}}}();
});